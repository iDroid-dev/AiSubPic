@layout.app({ title: "–ü–ª–∞—Ç–µ–∂–∏" })

@slot('main')
  <div class="mb-6">
    <h1 class="text-3xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h1>
    <p class="text-sm opacity-70">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∑–∞–∫–∞–∑—ã) –∏–∑ –≤—Å–µ—Ö –±–æ—Ç–æ–≤</p>
  </div>

  <div class="card bg-base-100 shadow-xl border border-base-200">
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–ë–æ—Ç</th>
            <th>–¢–∞—Ä–∏—Ñ / –°—É–º–º–∞</th>
            <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–∞—Ç–∞</th>
            <th class="text-right">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          @each(order in orders)
            <tr>
              <td class="font-mono text-xs text-opacity-50">#{{ order.id }}</td>
              
              <td>
                <div class="flex flex-col">
                  <span class="font-bold">
                    {{ order.user?.fullName || order.user?.username || 'ID: ' + order.userId }}
                  </span>
                  <span class="text-xs opacity-50">{{ order.user?.telegramId || '‚Äî' }}</span>
                </div>
              </td>

              <td>
                <div class="badge badge-outline badge-sm whitespace-nowrap">
                  {{ order.bot?.name || '–£–¥–∞–ª–µ–Ω' }}
                </div>
              </td>

              <td>
                <div class="flex flex-col">
                  <span class="font-bold">{{ order.plan?.name || '–ü–∞–∫–µ—Ç' }}</span>
                  <span class="text-success text-xs font-semibold">
                    {{ order.amount }} {{ order.currency }}
                  </span>
                </div>
              </td>

              <td>
                <span class="uppercase text-xs font-bold tracking-wider">
                  {{ order.paymentProvider }}
                </span>
              </td>

              <td>
                @if(order.status === 'paid')
                  <div class="badge badge-success text-white gap-2">
                    ‚úÖ –û–ø–ª–∞—á–µ–Ω
                  </div>
                @elseif(order.status === 'canceled')
                  <div class="badge badge-error text-white">‚ùå –û—Ç–º–µ–Ω–µ–Ω</div>
                @else
                  <div class="badge badge-warning text-white animate-pulse">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</div>
                @endif
              </td>

              <td class="text-xs whitespace-nowrap">
                {{ order.createdAt.toFormat('dd.MM.yyyy HH:mm') }}
              </td>

              <td class="text-right">
                <div class="flex justify-end gap-2">
                  @if(order.status === 'pending')
                    <form 
                      action="{{ route('admin.payments.approve', { id: order.id }) }}" 
                      method="POST" 
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –í–†–£–ß–ù–£–Æ? –Æ–∑–µ—Ä—É –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –∫—Ä–µ–¥–∏—Ç—ã –ø–æ —Ç–∞—Ä–∏—Ñ—É.')"
                    >
                      {{ csrfField() }}
                      <button type="submit" class="btn btn-xs btn-primary btn-outline">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                      </button>
                    </form>
                  @endif

                  {{-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –º–æ–¥–∞–ª–∫–∏ —Å –ª–æ–≥–æ–º --}}
                  @if(order.providerResponse)
                    <button 
                      class="btn btn-xs btn-ghost btn-square" 
                      onclick="showLogModal('{{ order.id }}', {{ JSON.stringify(order.providerResponse) }})"
                      title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥"
                    >
                      üìã
                    </button>
                  @endif
                </div>
              </td>
            </tr>
          @else
            <tr>
              <td colspan="8" class="text-center py-10 opacity-50 font-italic">
                –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç
              </td>
            </tr>
          @endeach
        </tbody>
      </table>
    </div>
  </div>

  {{-- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ú–û–î–ê–õ–ö–ê –î–õ–Ø –õ–û–ì–û–í --}}
  <dialog id="log_modal" class="modal">
    <div class="modal-box w-11/12 max-w-3xl">
      <h3 class="font-bold text-lg mb-4">–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ #<span id="modal_order_id"></span></h3>
      
      <div class="bg-neutral text-neutral-content p-4 rounded-lg overflow-x-auto">
        <pre id="modal_json_content" class="text-xs leading-relaxed"></pre>
      </div>
      
      <div class="modal-action">
        <form method="dialog">
          <button class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  {{-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∏ --}}
  <script>
    function showLogModal(id, data) {
      document.getElementById('modal_order_id').innerText = id;
      // –ö—Ä–∞—Å–∏–≤–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
      document.getElementById('modal_json_content').innerText = JSON.stringify(data, null, 2);
      log_modal.showModal();
    }
  </script>

@endslot
@end